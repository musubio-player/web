<!--
An element for fetching Musubio channels

Example:

    <channel-details></channel-details>

@element channel-details
-->
<dom-module id="channel-details">
  <template>
    <iron-ajax
      auto
      url="{{apiHost}}/_ah/api/musubio/v1/channels/{{channelId}}"
      handle-as="json"
      on-response="responseChannel"
      last-response="{{channel}}">
    </iron-ajax>

    <iframe
        width="800"
        height="450"
        src="https://www.youtube.com/embed/{{currentVideo.video_id}}?rel=0&amp;showinfo=0&autoplay=1&controls=1&start={{videoStartTime}}"
        frameborder="0"
        allowfullscreen>
    </iframe>

    <div class="current-video">
      <h1>{{currentVideo.title}}</h1>
      <div>{{currentVideo.description}}</div>
    </div>

    <div class="channel-info">
      <h3>{{channel.title}}</h3>
      <div>{{channel.description}}</div>
    </div>

    <h2>Playlist</h2>
    <template class="playlist" is="dom-repeat" items="{{channel.videos}}" as="video">
      <img src="{{video.image.medium}}">
    </template>
    <br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />

  </template>
</dom-module>

<script>
  Polymer({
    is: 'channel-details',
    properties: {
      apiHost: {
        type: String,
        value: musubioApiHost
      },
      videoStartTime: {
        type: Number
      },
      currentVideoId: {
        type: String
      }
    },
    responseChannel: function(request) {
      // Get the channel/video data from the API response.
      var channel = request.detail.response;
      var videos = channel.videos;

      var playlistTotalDuration = 0;
      videos.forEach(function(video) {
        playlistTotalDuration += parseInt(video.duration);
      });

      var now = Math.floor(new Date().getTime() / 1000);
      var baseTime = Math.floor(new Date(channel.created).getTime() / 1000);
      var timeSinceBaseTime = now - baseTime;
      var playlistStartTime = timeSinceBaseTime % playlistTotalDuration;

      var currDuration = 0;
      var videoIndex = 0;
      var videoStartTime = 0;
      videos.forEach(function(video, index) {
        if (playlistStartTime >= currDuration) {
          videoIndex = index;
          videoStartTime = playlistStartTime - currDuration;
        }

        currDuration += parseInt(video.duration);
      });

      // Set the video and start time.
      this.currentVideo = videos[videoIndex];
      this.videoStartTime = videoStartTime;
    }
  });

</script>